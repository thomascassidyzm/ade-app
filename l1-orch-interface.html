<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADE - Build Your App</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #11111a;
            --bg-chat: #0d0d12;
            --accent: #00d4ff;
            --accent-dim: #0095c0;
            --text: #ffffff;
            --text-secondary: #a1a1aa;
            --text-dim: #6b6b76;
            --border: #1a1a26;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --message-user: #1a1a26;
            --message-orch: #0f172a;
            --glow: rgba(0, 212, 255, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 30%, rgba(0, 212, 255, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 80% 70%, rgba(124, 58, 237, 0.06) 0%, transparent 50%);
            animation: drift 20s ease-in-out infinite;
            z-index: 0;
        }

        @keyframes drift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(-10px, -20px) rotate(1deg); }
            66% { transform: translate(10px, -10px) rotate(-1deg); }
        }

        .app-container {
            position: relative;
            z-index: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, var(--bg-secondary) 0%, rgba(17, 17, 26, 0.8) 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent) 0%, #7c3aed 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: var(--bg-primary);
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent) 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
            animation: pulse 2s infinite;
        }

        .status-dot.connecting {
            background: var(--warning);
            box-shadow: 0 0 8px var(--warning);
        }

        .status-dot.offline {
            background: var(--error);
            box-shadow: 0 0 8px var(--error);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        /* Main chat area */
        .chat-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            scroll-behavior: smooth;
        }

        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Messages */
        .message {
            margin-bottom: 1.5rem;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-user {
            display: flex;
            justify-content: flex-end;
        }

        .message-content {
            max-width: 80%;
            padding: 1rem 1.25rem;
            border-radius: 16px;
            position: relative;
        }

        .message-user .message-content {
            background: var(--message-user);
            border-bottom-right-radius: 4px;
        }

        .message-orch .message-content {
            background: var(--message-orch);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-bottom-left-radius: 4px;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.1);
        }

        .message-text {
            line-height: 1.6;
            word-wrap: break-word;
        }

        .message-text p {
            margin-bottom: 0.75rem;
        }

        .message-text p:last-child {
            margin-bottom: 0;
        }

        .message-text code {
            background: rgba(0, 212, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }

        .message-text pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.75rem 0;
        }

        .message-text pre code {
            background: none;
            padding: 0;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 0.5rem;
        }

        /* Status messages */
        .status-message {
            text-align: center;
            margin: 2rem 0;
        }

        .status-content {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 0.75rem 1.5rem;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 24px;
            font-size: 0.875rem;
            color: var(--accent);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 1rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: translateY(0);
            }
            30% {
                opacity: 1;
                transform: translateY(-10px);
            }
        }

        /* Input area */
        .input-container {
            background: linear-gradient(180deg, rgba(17, 17, 26, 0.8) 0%, var(--bg-secondary) 100%);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            padding: 1.5rem 2rem;
        }

        .input-wrapper {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
        }

        .input-field {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem 3.5rem 1rem 1.5rem;
            font-size: 1rem;
            color: var(--text);
            resize: none;
            font-family: inherit;
            line-height: 1.5;
            transition: all 0.3s ease;
            min-height: 56px;
            max-height: 200px;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .input-field::placeholder {
            color: var(--text-dim);
        }

        .send-button {
            position: absolute;
            right: 8px;
            bottom: 8px;
            width: 40px;
            height: 40px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .send-button:hover {
            background: var(--accent-dim);
            transform: scale(1.05);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Welcome screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 3rem;
            height: 100%;
        }

        .welcome-icon {
            font-size: 5rem;
            margin-bottom: 2rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--accent) 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-subtitle {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-bottom: 3rem;
            max-width: 600px;
        }

        .quick-starts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            max-width: 800px;
            width: 100%;
        }

        .quick-start-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .quick-start-card:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 212, 255, 0.2);
        }

        .quick-start-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }

        .quick-start-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--accent);
        }

        .quick-start-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Side panel for APML viz etc */
        .side-panel {
            width: 400px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .side-panel.active {
            display: flex;
        }

        .side-panel-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .side-panel-title {
            font-weight: 600;
            color: var(--accent);
        }

        .close-panel {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 4px;
        }

        .close-panel:hover {
            color: var(--text);
        }

        .side-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .messages-container {
                padding: 1rem;
            }

            .message-content {
                max-width: 90%;
            }

            .side-panel {
                position: fixed;
                top: 0;
                right: 0;
                height: 100%;
                z-index: 100;
                width: 100%;
                max-width: 400px;
                box-shadow: -4px 0 20px rgba(0, 0, 0, 0.5);
            }

            .welcome-title {
                font-size: 2rem;
            }

            .welcome-subtitle {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">A</div>
                <div class="logo-text">ADE Master Builder</div>
            </div>
            <div class="header-actions">
                <div class="status-indicator">
                    <div :class="['status-dot', statusClass]"></div>
                    <span>{{ statusText }}</span>
                </div>
            </div>
        </div>

        <!-- Main chat area -->
        <div class="chat-container">
            <div class="chat-main">
                <div class="messages-container" ref="messagesContainer">
                    <!-- Welcome screen -->
                    <div v-if="messages.length === 0" class="welcome-screen">
                        <div class="welcome-icon">üèóÔ∏è</div>
                        <h1 class="welcome-title">Let's Build Your App</h1>
                        <p class="welcome-subtitle">
                            I'm your Master Builder. Describe what you want to create, and I'll orchestrate a team of specialized agents to build it for you.
                        </p>
                        <div class="quick-starts">
                            <div class="quick-start-card" @click="sendQuickStart('I need a task management app with user accounts and team collaboration')">
                                <div class="quick-start-icon">üìã</div>
                                <div class="quick-start-title">Task Manager</div>
                                <div class="quick-start-desc">Project management with teams</div>
                            </div>
                            <div class="quick-start-card" @click="sendQuickStart('Build me an e-commerce store for handmade crafts with Stripe payments')">
                                <div class="quick-start-icon">üõçÔ∏è</div>
                                <div class="quick-start-title">E-commerce Store</div>
                                <div class="quick-start-desc">Online shop with payments</div>
                            </div>
                            <div class="quick-start-card" @click="sendQuickStart('Create a learning platform for teaching languages with progress tracking')">
                                <div class="quick-start-icon">üéì</div>
                                <div class="quick-start-title">Learning Platform</div>
                                <div class="quick-start-desc">Educational app with tracking</div>
                            </div>
                            <div class="quick-start-card" @click="sendQuickStart('I want a social app for book clubs to discuss and rate books')">
                                <div class="quick-start-icon">üìö</div>
                                <div class="quick-start-title">Social App</div>
                                <div class="quick-start-desc">Community and discussions</div>
                            </div>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div v-for="message in messages" :key="message.id" :class="['message', message.type]">
                        <div class="message-content">
                            <div class="message-text" v-html="formatMessage(message.content)"></div>
                            <div class="message-time">{{ formatTime(message.timestamp) }}</div>
                        </div>
                    </div>

                    <!-- Status messages -->
                    <div v-if="currentStatus" class="status-message">
                        <div class="status-content">
                            <span>{{ currentStatus }}</span>
                        </div>
                    </div>

                    <!-- Typing indicator -->
                    <div v-if="isTyping" class="message message-orch">
                        <div class="message-content">
                            <div class="typing-indicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input area -->
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea 
                            v-model="inputText"
                            @keydown.enter.prevent="handleEnter"
                            class="input-field"
                            placeholder="Describe the app you want to build..."
                            :disabled="!connected || sending"
                            ref="inputField"
                        ></textarea>
                        <button 
                            @click="sendMessage"
                            :disabled="!inputText.trim() || !connected || sending"
                            class="send-button"
                        >
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Side panel for visualizations -->
            <div :class="['side-panel', { active: showSidePanel }]">
                <div class="side-panel-header">
                    <div class="side-panel-title">{{ sidePanelTitle }}</div>
                    <button @click="showSidePanel = false" class="close-panel">√ó</button>
                </div>
                <div class="side-panel-content" v-html="sidePanelContent"></div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                // State
                const messages = ref([]);
                const inputText = ref('');
                const connected = ref(false);
                const sending = ref(false);
                const isTyping = ref(false);
                const currentStatus = ref('');
                const showSidePanel = ref(false);
                const sidePanelTitle = ref('');
                const sidePanelContent = ref('');
                const messagesContainer = ref(null);
                const inputField = ref(null);

                // WebSocket connection
                let ws = null;
                let reconnectTimer = null;
                let messageId = 0;

                // API configuration
                const wsUrl = window.location.hostname === 'localhost' 
                    ? 'ws://localhost:3000/ws' 
                    : `wss://${window.location.host}/ws`;

                const apiUrl = window.location.hostname === 'localhost' 
                    ? 'http://localhost:3000/api' 
                    : '/api';

                // Computed
                const statusClass = computed(() => {
                    if (!connected.value) return 'offline';
                    if (sending.value) return 'connecting';
                    return '';
                });

                const statusText = computed(() => {
                    if (!connected.value) return 'Connecting...';
                    if (sending.value) return 'Building...';
                    return 'Ready';
                });

                // Connect to L1_ORCH
                function connectWebSocket() {
                    // For now, we'll use HTTP polling instead of WebSocket
                    // This can be upgraded to real WebSocket later
                    connected.value = true;
                    pollMessages();
                }

                // Poll for messages (temporary until WebSocket is implemented)
                async function pollMessages() {
                    try {
                        const response = await fetch(`${apiUrl}/messages?limit=50`);
                        const data = await response.json();
                        
                        // Filter for L1_ORCH messages
                        const orchMessages = data.messages
                            .filter(m => m.from === 'L1_ORCH' || m.to === 'L1_ORCH')
                            .map(m => ({
                                id: m.id,
                                type: m.from === 'L1_ORCH' ? 'message-orch' : 'message-user',
                                content: m.content,
                                timestamp: m.timestamp
                            }));

                        // Update messages if new ones arrived
                        if (orchMessages.length > messages.value.length) {
                            messages.value = orchMessages;
                            scrollToBottom();
                        }
                    } catch (error) {
                        console.error('Failed to poll messages:', error);
                    }

                    // Continue polling
                    setTimeout(pollMessages, 2000);
                }

                // Send message
                async function sendMessage() {
                    if (!inputText.value.trim() || !connected.value || sending.value) return;

                    const content = inputText.value.trim();
                    inputText.value = '';

                    // Add user message
                    messages.value.push({
                        id: `msg-${++messageId}`,
                        type: 'message-user',
                        content,
                        timestamp: new Date().toISOString()
                    });

                    sending.value = true;
                    isTyping.value = true;
                    scrollToBottom();

                    try {
                        // Send to L1_ORCH through the hub
                        const response = await fetch(`${apiUrl}/messages`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                from: 'user',
                                to: 'L1_ORCH',
                                type: 'build_request',
                                content
                            })
                        });

                        if (!response.ok) throw new Error('Failed to send message');

                        // Simulate L1_ORCH thinking (will be replaced by real response)
                        setTimeout(() => {
                            isTyping.value = false;
                            messages.value.push({
                                id: `msg-${++messageId}`,
                                type: 'message-orch',
                                content: `I understand you want to build: "${content}"\n\nLet me analyze your requirements and create an APML specification for this app. I'll coordinate with specialized agents to handle:\n\n‚Ä¢ Frontend development\n‚Ä¢ Backend APIs\n‚Ä¢ Database design\n‚Ä¢ Authentication\n‚Ä¢ Deployment\n\nStarting the build process now...`,
                                timestamp: new Date().toISOString()
                            });
                            sending.value = false;
                            scrollToBottom();

                            // Show build status
                            showBuildStatus();
                        }, 2000);

                    } catch (error) {
                        console.error('Failed to send message:', error);
                        isTyping.value = false;
                        sending.value = false;
                        messages.value.push({
                            id: `msg-${++messageId}`,
                            type: 'message-orch',
                            content: 'Sorry, I had trouble processing that. Please try again.',
                            timestamp: new Date().toISOString()
                        });
                    }
                }

                // Show build status updates
                function showBuildStatus() {
                    const statuses = [
                        'üìã Creating APML specification...',
                        'üé® Frontend agent designing UI components...',
                        '‚öôÔ∏è Backend agent setting up APIs...',
                        'üóÉÔ∏è Database agent configuring data models...',
                        'üîê Security agent implementing authentication...',
                        'üöÄ Deployment agent preparing production build...',
                        '‚úÖ Build complete! Your app is ready.'
                    ];

                    let index = 0;
                    const interval = setInterval(() => {
                        currentStatus.value = statuses[index];
                        index++;

                        if (index >= statuses.length) {
                            clearInterval(interval);
                            currentStatus.value = '';
                            
                            // Add completion message
                            messages.value.push({
                                id: `msg-${++messageId}`,
                                type: 'message-orch',
                                content: `üéâ **Your app has been built successfully!**\n\nHere's what I've created for you:\n\n‚Ä¢ **Frontend**: Responsive Vue.js application\n‚Ä¢ **Backend**: Secure API with authentication\n‚Ä¢ **Database**: Optimized data models\n‚Ä¢ **Deployment**: Live at https://your-app.vercel.app\n\n[View Live App](https://your-app.vercel.app) | [View APML Spec](#) | [Download Code](#)\n\nWould you like me to make any changes or add features?`,
                                timestamp: new Date().toISOString()
                            });
                            scrollToBottom();
                        }
                    }, 3000);
                }

                // Quick start templates
                function sendQuickStart(template) {
                    inputText.value = template;
                    sendMessage();
                }

                // Format message with markdown
                function formatMessage(content) {
                    // Simple markdown parsing
                    return marked.parse(content);
                }

                // Format timestamp
                function formatTime(timestamp) {
                    const date = new Date(timestamp);
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }

                // Handle enter key
                function handleEnter(event) {
                    if (!event.shiftKey) {
                        sendMessage();
                    } else {
                        // Allow new line with Shift+Enter
                        inputText.value += '\n';
                    }
                }

                // Scroll to bottom
                async function scrollToBottom() {
                    await nextTick();
                    if (messagesContainer.value) {
                        messagesContainer.value.scrollTop = messagesContainer.value.scrollHeight;
                    }
                }

                // Auto-resize textarea
                function autoResize() {
                    if (inputField.value) {
                        inputField.value.style.height = 'auto';
                        inputField.value.style.height = inputField.value.scrollHeight + 'px';
                    }
                }

                // Initialize
                onMounted(() => {
                    connectWebSocket();
                    
                    // Focus input
                    if (inputField.value) {
                        inputField.value.focus();
                    }

                    // Auto-resize textarea
                    if (inputField.value) {
                        inputField.value.addEventListener('input', autoResize);
                    }
                });

                return {
                    messages,
                    inputText,
                    connected,
                    sending,
                    isTyping,
                    currentStatus,
                    showSidePanel,
                    sidePanelTitle,
                    sidePanelContent,
                    messagesContainer,
                    inputField,
                    statusClass,
                    statusText,
                    sendMessage,
                    sendQuickStart,
                    formatMessage,
                    formatTime,
                    handleEnter
                };
            }
        }).mount('#app');
    </script>
</body>
</html>